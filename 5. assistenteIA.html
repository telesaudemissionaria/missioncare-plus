<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Assistente IA - MissionCare Plus</title>

    <!-- Importação de Fontes e Tailwind CSS -->
    <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?display=swap&family=Lexend:wght@400;500;700;900&family=Noto+Sans:wght@400;500;700;900">
    <script src="https://cdn.tailwindcss.com?plugins=forms"></script>
    <link rel="stylesheet" href="style.css">

    <style>
        body {
            font-family: 'Lexend', 'Noto Sans', sans-serif;
            --primary-color: #0d9488; /* Tailwind teal-600 */
            --primary-color-light: #f0fdfa; /* Tailwind teal-50 */
            --text-color-dark: #374151; /* gray-700 */
            --text-color-light: #6b7280; /* gray-500 */
            --background-color-light: #f9fafb; /* gray-50 */
        }
        #chat-container {
            scroll-behavior: smooth;
        }
        /* Animação de "digitando" */
        .typing-indicator span {
            height: 8px;
            width: 8px;
            float: left;
            margin: 0 1px;
            background-color: #9ca3af;
            display: block;
            border-radius: 50%;
            opacity: 0.4;
            animation: 1s blink infinite;
        }
        .typing-indicator span:nth-child(2) { animation-delay: .2s; }
        .typing-indicator span:nth-child(3) { animation-delay: .4s; }
        @keyframes blink {
            50% { opacity: 1; }
        }
    </style>
</head>
<body class="bg-white">

    <!-- Container da Aplicação -->
    <div id="app-container" class="relative flex size-full min-h-screen flex-col bg-white">

        <header class="sticky top-0 z-10 flex items-center bg-white/90 p-4 pb-3 backdrop-blur-sm border-b border-gray-200">
            <a href="#" class="text-gray-600 hover:text-gray-900 p-2 -ml-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor" viewBox="0 0 256 256"><path d="M224,128a8,8,0,0,1-8,8H59.31l58.35,58.34a8,8,0,0,1-11.32,11.32l-72-72a8,8,0,0,1,0-11.32l72-72a8,8,0,0,1,11.32,11.32L59.31,120H216A8,8,0,0,1,224,128Z"></path></svg>
            </a>
            <h1 class="text-gray-800 text-lg font-bold leading-tight tracking-[-0.015em] flex-1 text-center pr-8">Assistente IA</h1>
        </header>

        <!-- Área do Chat -->
        <main id="chat-container" class="flex-grow p-4 space-y-6 overflow-y-auto pb-40">
            <!-- Mensagem Inicial do Assistente -->
            <div class="flex items-end gap-3">
                <div class="flex-shrink-0 size-8 bg-teal-600 rounded-full flex items-center justify-center text-white font-bold text-sm">IA</div>
                <div class="flex flex-col gap-1 items-start">
                    <p class="text-sm font-normal text-text-color-light max-w-xs">Assistente IA</p>
                    <div class="text-base font-normal leading-normal flex max-w-xs rounded-xl rounded-bl-none px-4 py-3 bg-gray-100 text-text-color-dark">
                        Olá! Sou o MedGemma. Selecione uma ação abaixo ou me faça uma pergunta.
                    </div>
                </div>
            </div>
            <!-- Novas mensagens serão adicionadas aqui -->
        </main>

        <!-- Barra de Input Fixa -->
        <footer class="fixed bottom-0 left-0 right-0 bg-white/90 backdrop-blur-sm border-t border-gray-200">
            <div class="p-4">
                <!-- AÇÕES RÁPIDAS COM IA -->
                <div id="quick-actions" class="flex gap-2 mb-3 overflow-x-auto pb-2">
                    <button data-action="symptoms" class="quick-action-btn flex-shrink-0 text-sm font-semibold text-teal-700 bg-teal-50 px-4 py-2 rounded-full hover:bg-teal-100">✨ Analisar Sintomas</button>
                    <button data-action="med_info" class="quick-action-btn flex-shrink-0 text-sm font-semibold text-teal-700 bg-teal-50 px-4 py-2 rounded-full hover:bg-teal-100">✨ Info de Remédio</button>
                    <button data-action="first_aid" class="quick-action-btn flex-shrink-0 text-sm font-semibold text-teal-700 bg-teal-50 px-4 py-2 rounded-full hover:bg-teal-100">✨ Primeiros Socorros</button>
                </div>
                <div class="flex w-full items-center rounded-full border-2 border-gray-200 focus-within:border-teal-600 transition-colors duration-200">
                    <input id="chat-input" type="text" placeholder="Pergunte ao MedGemma..." class="form-input flex-grow bg-transparent border-none focus:ring-0 h-12 placeholder:text-gray-400 p-4 text-base"/>
                    <button id="send-btn" class="text-teal-600 hover:text-teal-800 p-3">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor" viewBox="0 0 256 256"><path d="M223.87,114l-168-95.89A16,16,0,0,0,32.93,37.32l31,90.47a.42.42,0,0,0,0,.1.3.3,0,0,0,0,.1l-31,90.67A16,16,0,0,0,48,240a16.14,16.14,0,0,0,7.92-2.1l167.91-96.05a16,16,0,0,0,.05-27.89ZM48,224l0-.09L78.14,136H136a8,8,0,0,0,0-16H78.22L48.06,32.12,48,32l168,95.83Z"></path></svg>
                    </button>
                </div>
                 <p class="text-text-color-light text-xs text-center pt-2 px-4">
                    As respostas são para fins educativos e não substituem a avaliação de um profissional de saúde.
                </p>
            </div>
        </footer>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const chatContainer = document.getElementById('chat-container');
    const chatInput = document.getElementById('chat-input');
    const sendBtn = document.getElementById('send-btn');
    const quickActionButtons = document.querySelectorAll('.quick-action-btn');

    const apiKey = 'AIzaSyAz6tEar6NJokgbEch5QLtbKL7dw_v6B3U'; 
    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${apiKey}`;

    // Armazena o modo de chat atual para construir o prompt correto
    let chatMode = 'general';
    let chatHistory = []; // Para manter o contexto da conversa

    // Função para construir prompts com base no modo de chat
    const buildPrompt = (message) => {
        const basePrompt = `Você é o MedGemma, um assistente médico de IA empático, profissional e cristocêntrico, treinado para auxiliar missionários em áreas remotas da Bolívia. Seu lema é 'Medicina em Nome de Jesus'. Suas respostas devem ser curtas, diretas e de fácil compreensão, evitando jargões médicos ou termos técnicos. Devem ser claras, baseadas em evidências, mas também encorajadoras. Considere sempre as limitações de recursos. NUNCA forneça um diagnóstico definitivo. Finalize as respostas com um lembrete para consultar a equipe de telessaúde se a dúvida persistir.`;

        switch (chatMode) {
            case 'symptoms':
                return `${basePrompt}\n\n**TAREFA: ANALISAR SINTOMAS**\nForneça uma análise inicial concisa com: 1. Hipóteses Prováveis, 2. Nível de Urgência (de Não Urgente a Emergência), 3. Recomendações Iniciais. \n\n**Dados do Paciente:** "${message}"`;
            case 'med_info':
                return `${basePrompt}\n\n**TAREFA: INFORMAÇÃO DE MEDICAMENTO**\nForneça um resumo sobre o medicamento: 1. Para que serve, 2. Como tomar (dosagem comum), 3. Efeitos colaterais, 4. Avisos importantes. \n\n**Medicamento:** "${message}"`;
            case 'first_aid':
                return `${basePrompt}\n\n**TAREFA: PRIMEIROS SOCORROS**\nForneça instruções passo a passo, claras e simples para a situação de emergência informada, adaptadas para um ambiente com poucos recursos. \n\n**Situação:** "${message}"`;
            default: // 'general'
                return `${basePrompt}\n\n**Pergunta do usuário:** "${message}"`;
        }
    };

    const handleSendMessage = async () => {
        const userMessage = chatInput.value.trim();
        if (!userMessage) return;

        appendMessage(userMessage, 'user');
        chatInput.value = '';
        chatInput.placeholder = "Pergunte ao MedGemma..."; // Reseta o placeholder
        showTypingIndicator();

        const currentPrompt = buildPrompt(userMessage);
        
        // Adiciona a mensagem atual ao histórico
        chatHistory.push({ role: "user", parts: [{ text: currentPrompt }] });

        try {
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents: chatHistory }) // Envia o histórico
            });

            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

            const result = await response.json();
            const aiResponse = result.candidates[0].content.parts[0].text;
            
            // Adiciona a resposta da IA ao histórico
            chatHistory.push({ role: "model", parts: [{ text: aiResponse }] });

            removeTypingIndicator();
            appendMessage(aiResponse, 'ai');

        } catch (error) {
            console.error("Erro ao chamar a API Gemini:", error);
            removeTypingIndicator();
            appendMessage("Desculpe, ocorreu um erro ao processar sua pergunta. Por favor, tente novamente.", 'ai', true);
        } finally {
            chatMode = 'general'; // Reseta o modo após cada envio
        }
    };

    // Event listeners para os botões de ação rápida
    quickActionButtons.forEach(button => {
        button.addEventListener('click', () => {
            const action = button.dataset.action;
            chatMode = action; // Define o modo de chat
            const placeholders = {
                symptoms: 'Descreva sintomas, idade e sexo. Ex: Homem 45 anos, febre alta...',
                med_info: 'Qual medicamento você quer pesquisar? Ex: Ibuprofeno',
                first_aid: 'Para qual emergência você precisa de ajuda? Ex: Queimadura leve'
            };
            chatInput.placeholder = placeholders[action];
            chatInput.focus();
        });
    });

    const appendMessage = (message, sender, isError = false) => {
        const messageDiv = document.createElement('div');
        
        if (sender === 'user') {
            messageDiv.className = 'flex items-end gap-3 justify-end';
            messageDiv.innerHTML = `
                <div class="flex flex-col gap-1 items-end">
                    <p class="text-sm font-normal text-text-color-light max-w-xs text-right">Você</p>
                    <div class="text-base font-normal leading-normal flex max-w-xs rounded-xl rounded-br-none px-4 py-3 bg-teal-600 text-white">${message}</div>
                </div>
                <div class="flex-shrink-0 size-8 bg-gray-300 rounded-full flex items-center justify-center text-gray-600 font-bold text-sm">V</div>
            `;
        } else { // AI
            messageDiv.className = 'flex items-end gap-3';
            const bgColor = isError ? 'bg-red-100' : 'bg-gray-100';
            const textColor = isError ? 'text-red-800' : 'text-text-color-dark';
            messageDiv.innerHTML = `
                <div class="flex-shrink-0 size-8 bg-teal-600 rounded-full flex items-center justify-center text-white font-bold text-sm">IA</div>
                <div class="flex flex-col gap-1 items-start">
                    <p class="text-sm font-normal text-text-color-light max-w-xs">Assistente IA</p>
                    <div class="text-base font-normal leading-normal flex max-w-xs rounded-xl rounded-bl-none px-4 py-3 ${bgColor} ${textColor}">${message.replace(/\n/g, '<br>')}</div>
                </div>
            `;
        }
        chatContainer.appendChild(messageDiv);
        chatContainer.scrollTop = chatContainer.scrollHeight;
    };

    const showTypingIndicator = () => {
        const typingDiv = document.createElement('div');
        typingDiv.id = 'typing-indicator';
        typingDiv.className = 'flex items-end gap-3';
        typingDiv.innerHTML = `
            <div class="flex-shrink-0 size-8 bg-teal-600 rounded-full flex items-center justify-center text-white font-bold text-sm">IA</div>
            <div class="flex flex-col gap-1 items-start">
                 <p class="text-sm font-normal text-text-color-light max-w-xs">Assistente IA</p>
                <div class="text-base font-normal leading-normal flex max-w-xs rounded-xl rounded-bl-none px-4 py-3 bg-gray-100 text-text-color-dark">
                    <div class="typing-indicator"><span></span><span></span><span></span></div>
                </div>
            </div>
        `;
        chatContainer.appendChild(typingDiv);
        chatContainer.scrollTop = chatContainer.scrollHeight;
    };

    const removeTypingIndicator = () => {
        const indicator = document.getElementById('typing-indicator');
        if (indicator) {
            indicator.remove();
        }
    };

    sendBtn.addEventListener('click', handleSendMessage);
    chatInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            handleSendMessage();
        }
    });
});
</script>

</body>
</html>
